{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'GPTrivia/css/buzzer.css' %}">
{% endblock %}

{% block extra_meta %}
<script>
    let isLocked = true; // Start with the button locked
    let lockTimeout = null; // Reference to the timeout

    // Create a WebSocket connection
    const socket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/button/'
    );

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const lastPressElement = document.getElementById('last-press');

        // Update the "Last person to press the button" text
        lastPressElement.textContent = data.username;
        console.log(`Received WebSocket message: ${data.username}`);
    };

    function sendPress() {
        const mainButton = document.getElementById('action-button');
        const username = document.getElementById('username').value;

        if (isLocked) {
            console.log("Button is already locked. Ignoring press.");
            resetLockTimeout(); // Reset the timeout if the button is clicked while locked
            return; // Ignore the press
        }

        if (username) {
            // Send data to WebSocket
            const message = { username: username };
            socket.send(JSON.stringify(message));
            console.log(`Message sent: ${username}`);

            // Lock the button for 2 seconds
            lockMainButton();
        } else {
            console.log("No username provided. Press ignored.");
        }
    }

    function lockMainButton() {
        const mainButton = document.getElementById('action-button');
        isLocked = true; // Set the lock state

        // Add a "locked" class for visual feedback
        mainButton.classList.add('locked');
        console.log("Button locked.");

        // Start or reset the unlock timeout
        resetLockTimeout();
    }

    function resetLockTimeout() {
        const mainButton = document.getElementById('action-button');

        // Clear any existing timeout
        if (lockTimeout) {
            clearTimeout(lockTimeout);
        }

        // Set a new timeout to unlock the button
        lockTimeout = setTimeout(() => {
            isLocked = false; // Reset the lock state
            mainButton.classList.remove('locked'); // Remove the visual feedback
            console.log("Button unlocked.");
        }, 2000);
    }

    function unlockMainButton() {
        const mainButton = document.getElementById('action-button');
        const unlockButton = document.getElementById('unlock-button');

        // Reset the lock state and remove visual feedback
        isLocked = false;
        if (lockTimeout) {
            clearTimeout(lockTimeout); // Clear any existing timeout
        }
        mainButton.classList.remove('locked');
        console.log("Main button manually unlocked.");

        // Disable the unlock button after use
        unlockButton.disabled = true;
        console.log("Unlock button disabled.");
    }

    document.addEventListener('DOMContentLoaded', () => {
        const mainButton = document.getElementById('action-button');
        const unlockButton = document.getElementById('unlock-button');

        // Initialize the locked state visually
        mainButton.classList.add('locked');
        console.log("Main button starts locked.");

        // Attach event listeners
        mainButton.addEventListener('click', sendPress);
        unlockButton.addEventListener('click', unlockMainButton);
    });
</script>
{% endblock %}

{% block content %}
<body>
    <h1>Press the Button!</h1>
    <label for="username">Your Name:</label>
    <div>
        <input type="text" id="username" placeholder="Enter your name" />
        <button id="action-button">Press Me!</button>
        <button id="unlock-button">Unlock Main Button</button>
        <h3>Last person to press the button:</h3>
        <p id="last-press">No one yet</p>
    </div>
</body>
</html>
{% endblock %}