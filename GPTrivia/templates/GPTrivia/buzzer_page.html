{% extends 'base.html' %}
{% load static %}
{% load custom_tags %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'GPTrivia/css/buzzer.css' %}">
{% endblock %}

{% block extra_meta %}
<script>
    let cooldown = false; // Prevents sending a press immediately after re-enabling

    function unlockMainButton() {
        const unlockButton = document.getElementById('unlock-button');
        const mainButton = document.getElementById('action-button');

        // Enable the main button
        mainButton.disabled = false;
        console.log("Main button unlocked.");

        // Disable the unlock button
        unlockButton.disabled = true;
        console.log("Unlock button deactivated.");
    }

    function sendPress() {
        const mainButton = document.getElementById('action-button');
        const username = document.getElementById('username').value;

        if (mainButton.disabled || cooldown) {
            console.log("Main button is in cooldown or disabled. Ignoring press.");
            return; // Do nothing if the button is disabled or in cooldown
        }

        if (username) {
            // Send data to WebSocket
            socket.send(JSON.stringify({ username: username }));
            console.log(`Message sent: ${username}`);

            // Lock the button and start cooldown
            lockMainButton();
        }
    }

    function lockMainButton() {
        const mainButton = document.getElementById('action-button');

        // Lock the button
        mainButton.disabled = true;
        cooldown = true; // Start cooldown
        console.log("Main button locked and cooldown started.");

        // Re-enable the button after 2 seconds
        setTimeout(() => {
            mainButton.disabled = false;
            console.log("Main button re-enabled.");
        }, 2000);

        // End the cooldown after 2 seconds
        setTimeout(() => {
            cooldown = false;
            console.log("Cooldown ended. Main button can send presses again.");
        }, 2000);
    }

    // WebSocket setup
    const socket = new WebSocket(
        (window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/button/'
    );

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);

        // Update the last-press text
        const lastPressElement = document.getElementById('last-press');
        lastPressElement.textContent = data.username;

        // Lock the main button on WebSocket message
        console.log("WebSocket message received. Locking main button.");
        lockMainButton();
    };
</script>
{% endblock %}

{% block content %}
<body>
    <h1>Press the Button!</h1>
    <label for="username">Your Name:</label>
    <input type="text" id="username" placeholder="Enter your name" />
    <div>
        <button id="unlock-button" onclick="unlockMainButton()">Unlock Main Button</button>
        <button id="action-button" onclick="sendPress()" disabled>Press Me!</button>
    </div>
    <h3>Last person to press the button:</h3>
    <p id="last-press">No one yet</p>
</body>
</html>
{% endblock %}